{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --primary-color: #007bff;
        --card-bg: #fff;
        --card-border: #dee2e6;
        --text-color: #495057;
        --text-muted: #6c757d;
    }

    #content-main {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        padding: 20px;
    }

    .periodo-selector {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .periodo-selector label {
        font-weight: 600;
        color: var(--text-color);
    }

    .periodo-selector select {
        padding: 8px 15px;
        border: 1px solid var(--card-border);
        border-radius: 5px;
        font-size: 14px;
    }

    .periodo-selector button {
        padding: 8px 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
    }

    .periodo-selector button:hover {
        opacity: 0.9;
    }

    .kpis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .kpi-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .kpi-card .icon {
        font-size: 2.5em;
        margin-bottom: 10px;
    }

    .kpi-card .icon.receita { color: var(--success-color); }
    .kpi-card .icon.despesa { color: var(--danger-color); }
    .kpi-card .icon.lucro { color: var(--primary-color); }
    .kpi-card .icon.receber { color: var(--warning-color); }
    .kpi-card .icon.pagar { color: var(--info-color); }

    .kpi-card .label {
        font-size: 0.9em;
        color: var(--text-muted);
        margin-bottom: 5px;
        text-transform: uppercase;
        font-weight: 600;
    }

    .kpi-card .value {
        font-size: 2em;
        font-weight: 700;
        color: var(--text-color);
    }

    .kpi-card .subtext {
        font-size: 0.85em;
        color: var(--text-muted);
        margin-top: 8px;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .chart-card h3 {
        margin-top: 0;
        color: var(--text-color);
        border-bottom: 2px solid var(--card-border);
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    .tables-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    @media (max-width: 1200px) {
        .tables-section {
            grid-template-columns: 1fr;
        }
    }

    .table-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .table-card h3 {
        margin-top: 0;
        color: var(--text-color);
        border-bottom: 2px solid var(--card-border);
        padding-bottom: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-card h3 .badge {
        background: var(--primary-color);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8em;
    }

    .financial-table {
        width: 100%;
        border-collapse: collapse;
    }

    .financial-table th,
    .financial-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--card-border);
    }

    .financial-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: var(--text-color);
    }

    .financial-table tr:hover {
        background: #f8f9fa;
    }

    .valor-positivo {
        color: var(--success-color);
        font-weight: 600;
    }

    .valor-negativo {
        color: var(--danger-color);
        font-weight: 600;
    }

    .alert-box {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        border-left: 4px solid;
    }

    .alert-success {
        background: #d4edda;
        border-color: var(--success-color);
        color: #155724;
    }

    .alert-warning {
        background: #fff3cd;
        border-color: var(--warning-color);
        color: #856404;
    }

    .alert-danger {
        background: #f8d7da;
        border-color: var(--danger-color);
        color: #721c24;
    }
</style>
{% endblock %}

{% block content %}
<h1><i class="fas fa-chart-line"></i> {{ title }}</h1>

<!-- Seletor de Período -->
<form method="get" class="periodo-selector">
    <label for="periodo">Analisar últimos:</label>
    <select name="periodo" id="periodo">
        {% for dias in periodos_disponiveis %}
        <option value="{{ dias }}" {% if dias == periodo_selecionado %}selected{% endif %}>
            {{ dias }} dias
        </option>
        {% endfor %}
    </select>
    <button type="submit"><i class="fas fa-sync"></i> Atualizar</button>
</form>

<!-- Alertas Importantes -->
{% if dados.lucro.confirmado < 0 %}
<div class="alert-box alert-danger">
    <strong><i class="fas fa-exclamation-triangle"></i> Atenção!</strong>
    Prejuízo de R$ {{ dados.lucro.confirmado|floatformat:2 }} no período analisado.
</div>
{% elif dados.contas_pagar.total > dados.receitas.receita_confirmada %}
<div class="alert-box alert-warning">
    <strong><i class="fas fa-exclamation-circle"></i> Alerta de Liquidez!</strong>
    Total a pagar (R$ {{ dados.contas_pagar.total|floatformat:2 }}) maior que receita confirmada.
</div>
{% else %}
<div class="alert-box alert-success">
    <strong><i class="fas fa-check-circle"></i> Situação Saudável!</strong>
    Lucro de R$ {{ dados.lucro.confirmado|floatformat:2 }} no período.
</div>
{% endif %}

<!-- KPIs Principais -->
<div class="kpis-grid">
    <!-- Receitas -->
    <div class="kpi-card">
        <div class="icon receita"><i class="fas fa-arrow-down"></i></div>
        <div class="label">Receita Confirmada</div>
        <div class="value valor-positivo">R$ {{ dados.receitas.receita_confirmada|floatformat:2 }}</div>
        <div class="subtext">
            {{ dados.receitas.total_inscricoes }} inscrições<br>
            Previsto: R$ {{ dados.receitas.receita_total_prevista|floatformat:2 }}
        </div>
    </div>

    <!-- Despesas -->
    <div class="kpi-card">
        <div class="icon despesa"><i class="fas fa-arrow-up"></i></div>
        <div class="label">Despesa Confirmada</div>
        <div class="value valor-negativo">R$ {{ dados.despesas.despesa_confirmada|floatformat:2 }}</div>
        <div class="subtext">
            Gastos Internos: R$ {{ dados.despesas.gastos_internos|floatformat:2 }}<br>
            Previsto: R$ {{ dados.despesas.despesa_total_prevista|floatformat:2 }}
        </div>
    </div>

    <!-- Lucro -->
    <div class="kpi-card">
        <div class="icon lucro"><i class="fas fa-chart-line"></i></div>
        <div class="label">Lucro Líquido</div>
        <div class="value {% if dados.lucro.confirmado >= 0 %}valor-positivo{% else %}valor-negativo{% endif %}">
            R$ {{ dados.lucro.confirmado|floatformat:2 }}
        </div>
        <div class="subtext">
            Margem: {{ dados.lucro.margem|floatformat:1 }}%<br>
            Previsto: R$ {{ dados.lucro.previsto|floatformat:2 }}
        </div>
    </div>

    <!-- Contas a Receber -->
    <div class="kpi-card">
        <div class="icon receber"><i class="fas fa-hand-holding-usd"></i></div>
        <div class="label">A Receber de Clientes</div>
        <div class="value">R$ {{ dados.contas_receber.total|floatformat:2 }}</div>
        <div class="subtext">
            {{ dados.contas_receber.quantidade }} inscrições pendentes
        </div>
    </div>

    <!-- Contas a Pagar -->
    <div class="kpi-card">
        <div class="icon pagar"><i class="fas fa-file-invoice-dollar"></i></div>
        <div class="label">A Pagar a Fornecedores</div>
        <div class="value">R$ {{ dados.contas_pagar.total|floatformat:2 }}</div>
        <div class="subtext">
            {{ dados.contas_pagar.quantidade }} cotações pendentes
        </div>
    </div>

    <!-- Saldo Líquido Previsto -->
    <div class="kpi-card">
        <div class="icon lucro"><i class="fas fa-wallet"></i></div>
        <div class="label">Saldo Líquido Previsto</div>
        <div class="value {% if dados.saldo_liquido_previsto >= 0 %}valor-positivo{% else %}valor-negativo{% endif %}">
            R$ {{ dados.saldo_liquido_previsto|floatformat:2 }}
        </div>
        <div class="subtext">
            Caixa + A Receber - A Pagar
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="charts-grid">
    <div class="chart-card">
        <h3><i class="fas fa-chart-bar"></i> Receitas vs Despesas</h3>
        <canvas id="chartReceitasDespesas"></canvas>
    </div>

    <div class="chart-card">
        <h3><i class="fas fa-chart-pie"></i> Composição de Despesas</h3>
        <canvas id="chartComposicaoDespesas"></canvas>
    </div>
</div>

<div class="chart-card" style="margin-bottom: 30px;">
    <h3><i class="fas fa-trophy"></i> Resultado por Passeio (Top 5)</h3>
    <canvas id="chartResultadoPasseios"></canvas>
</div>

<!-- Tabelas de Contas -->
<div class="tables-section">
    <!-- Contas a Receber -->
    <div class="table-card">
        <h3>
            <span><i class="fas fa-hand-holding-usd"></i> Contas a Receber</span>
            <span class="badge">{{ dados.contas_receber.quantidade }}</span>
        </h3>
        {% if dados.contas_receber.lista %}
        <table class="financial-table">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Passeio</th>
                    <th>Saldo</th>
                </tr>
            </thead>
            <tbody>
                {% for conta in dados.contas_receber.lista %}
                <tr>
                    <td>{{ conta.cliente.nome }}</td>
                    <td>{{ conta.pacote.passeio.titulo|truncatechars:30 }}</td>
                    <td class="valor-negativo">R$ {{ conta.saldo_devedor|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: var(--text-muted); text-align: center; padding: 20px;">
            Nenhuma conta a receber no momento.
        </p>
        {% endif %}
    </div>

    <!-- Contas a Pagar -->
    <div class="table-card">
        <h3>
            <span><i class="fas fa-file-invoice-dollar"></i> Contas a Pagar</span>
            <span class="badge">{{ dados.contas_pagar.quantidade }}</span>
        </h3>
        {% if dados.contas_pagar.lista %}
        <table class="financial-table">
            <thead>
                <tr>
                    <th>Fornecedor</th>
                    <th>Serviço</th>
                    <th>Saldo</th>
                    <th>Vencimento</th>
                </tr>
            </thead>
            <tbody>
                {% for conta in dados.contas_pagar.lista %}
                <tr>
                    <td>{{ conta.fornecedor.nome_fantasia }}</td>
                    <td>{{ conta.get_tipo_servico_display }}</td>
                    <td class="valor-negativo">R$ {{ conta.saldo_a_pagar|floatformat:2 }}</td>
                    <td>{{ conta.data_vencimento_pagamento|date:"d/m/Y"|default:"Sem data" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: var(--text-muted); text-align: center; padding: 20px;">
            Nenhuma conta a pagar no momento.
        </p>
        {% endif %}
    </div>
</div>

<!-- Resultado por Passeio -->
{% if dados.resultados_passeios %}
<div class="table-card">
    <h3>
        <span><i class="fas fa-chart-line"></i> Análise de Rentabilidade por Passeio</span>
    </h3>
    <table class="financial-table">
        <thead>
            <tr>
                <th>Passeio</th>
                <th>Receita</th>
                <th>Custo</th>
                <th>Lucro</th>
                <th>Margem %</th>
            </tr>
        </thead>
        <tbody>
            {% for resultado in dados.resultados_passeios %}
            <tr>
                <td>{{ resultado.passeio.titulo }}</td>
                <td class="valor-positivo">R$ {{ resultado.receita|floatformat:2 }}</td>
                <td class="valor-negativo">R$ {{ resultado.custo|floatformat:2 }}</td>
                <td class="{% if resultado.lucro >= 0 %}valor-positivo{% else %}valor-negativo{% endif %}">
                    R$ {{ resultado.lucro|floatformat:2 }}
                </td>
                <td>{{ resultado.margem_percentual|floatformat:1 }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% endblock %}

{% block extrajs %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico Receitas vs Despesas
    const dataReceitasDespesas = {{ chart_receitas_despesas_json|safe }};
    new Chart(document.getElementById('chartReceitasDespesas'), {
        type: 'bar',
        data: {
            labels: dataReceitasDespesas.labels,
            datasets: [{
                label: 'Valor (R$)',
                data: dataReceitasDespesas.data,
                backgroundColor: dataReceitasDespesas.colors,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Gráfico Resultado por Passeio
    const dataResultadoPasseios = {{ chart_resultado_passeios_json|safe }};
    new Chart(document.getElementById('chartResultadoPasseios'), {
        type: 'bar',
        data: {
            labels: dataResultadoPasseios.labels,
            datasets: [{
                label: 'Lucro/Prejuízo (R$)',
                data: dataResultadoPasseios.data,
                backgroundColor: dataResultadoPasseios.colors,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Gráfico Composição de Despesas
    const dataComposicaoDespesas = {{ chart_composicao_despesas_json|safe }};
    new Chart(document.getElementById('chartComposicaoDespesas'), {
        type: 'doughnut',
        data: {
            labels: dataComposicaoDespesas.labels,
            datasets: [{
                data: dataComposicaoDespesas.data,
                backgroundColor: [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', 
                    '#17a2b8', '#6c757d', '#e83e8c', '#fd7e14'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'right' }
            }
        }
    });
});
</script>
{% endblock %}
