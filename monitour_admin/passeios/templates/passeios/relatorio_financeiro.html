{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div id="content-main">
    <p>Use este painel para planejar os custos e a lucratividade do seu passeio.</p>

    <style>
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 15px; }
        .card h2 { margin-top: 0; font-size: 1.2em; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .card h4 { margin-bottom: 5px; margin-top: 15px; }
        .card ul { padding-left: 20px; margin: 0; }
        .card li { margin-bottom: 5px; }
        .summary-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .summary-item:last-child { border-bottom: none; }
        .summary-item strong { font-size: 1.1em; }
        .total { font-weight: bold; font-size: 1.3em; }
        .lucro { color: #28a745; }
        .sugestao { color: #007bff; }
        .atencao { color: #ffc107; }
        .prejuizo { color: #dc3545; }
        .status-card { text-align: center; padding: 20px; border-radius: 8px; color: white; margin-bottom: 20px; }
        .status-card h2 { margin: 0; font-size: 2em; }
        .status-card p { margin: 5px 0 0 0; opacity: 0.9; }
        .metric-box { text-align: center; }
        .metric-box .value { font-size: 2em; font-weight: bold; display: block; }
        .metric-box .label { font-size: 0.9em; color: #666; }
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }

        /* Estilos para Impress√£o */
        @media print {
            body { background-color: #fff; }
            #header, #nav-sidebar, .breadcrumbs, .action-buttons, .module a.button {
                display: none !important;
            }
            #content-main {
                width: 100%;
                padding: 0;
                margin: 0;
            }
            .dashboard-grid {
                grid-template-columns: 1fr !important; /* Uma coluna na impress√£o */
            }
            .card {
                border: 1px solid #ccc;
                page-break-inside: avoid; /* Evita que um card seja quebrado entre p√°ginas */
                box-shadow: none;
            }
            h1 { font-size: 16pt; }
            p, small, .label { font-size: 9pt; }
        }
    </style>

    <div class="dashboard-grid">
        <div class="card">
            <div class="status-card" style="background-color: {{ status_viabilidade.cor }};">
                <h2>{{ status_viabilidade.texto }}</h2>
                <p>{{ status_viabilidade.descricao }}</p>
            </div>

            <h2><span style="font-size: 1.5em;">üí∞</span> Custos do Passeio</h2>
            <p>Liste aqui todos os gastos planejados. Adicione cota√ß√µes e gastos na <a href="{% url 'admin:passeios_passeio_change' passeio.pk %}">p√°gina de edi√ß√£o do passeio</a>.</p>
            <hr>
            
            <h4>Cota√ß√µes de Fornecedores (Aceitas)</h4>
            <ul>
                {% for cotacao in custos_detalhados.cotacoes_aceitas %}
                    <li>{{ cotacao.get_tipo_servico_display }} ({{ cotacao.fornecedor.nome_fantasia }}): <strong>R$ {{ cotacao.valor_cotado|floatformat:2 }}</strong></li>
                {% empty %}
                    <li>Nenhuma cota√ß√£o aceita.</li>
                {% endfor %}
            </ul>

            <h4>Gastos Internos</h4>
            <ul>
                {% for gasto in custos_detalhados.gastos_internos %}
                    <li>{{ gasto.descricao }}: <strong>R$ {{ gasto.valor|floatformat:2 }}</strong></li>
                {% empty %}
                    <li>Nenhum gasto interno registrado.</li>
                {% endfor %}
            </ul>
            <hr>
            <div class="summary-item">
                <span>Custo Total Previsto</span>
                <span class="total prejuizo">R$ {{ custo_total_previsto|floatformat:2 }}</span>
            </div>
            <div style="max-width: 350px; margin: 20px auto 0 auto;">
                {% if chart_data_json != '{"labels": [], "data": []}' %}
                    <canvas id="costsChart"></canvas>
                {% else %}
                    <p style="text-align: center; color: #888; padding: 20px 0;">Adicione custos para visualizar o gr√°fico.</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <h2><span style="font-size: 1.5em;">üéØ</span> An√°lise de Pre√ßo por Ingresso</h2>
            <p>Com base nos custos e na <strong>capacidade do ve√≠culo ({{ passeio.tipo_veiculo.capacidade|default:"N/A" }} lugares)</strong>, o sistema sugere os pre√ßos de venda.</p>
            <hr>

            <div class="summary-item" style="background-color: #fffbe6; padding: 10px; border-radius: 4px;">
                <span>Custo por Pessoa (Ponto de Equil√≠brio)</span>
                <span class="total prejuizo">R$ {{ custo_por_pessoa_break_even|floatformat:2 }}</span>
            </div>
            <p style="font-size: 0.9em; text-align: center; margin-top: 5px;">Este √© o valor que cada passageiro custa para voc√™.</p>

            <hr>

            <div style="background-color: #e6f7ff; padding: 15px; border-radius: 4px; margin-top: 15px;">
                <h4 style="margin-top:0; text-align:center;">Pre√ßos de Venda Sugeridos</h4>
                <div class="summary-item" style="border-bottom: 1px dashed #ccc; padding-bottom: 15px; margin-bottom: 10px;">
                    <div>
                        <strong style="font-size: 1.2em;" class="sugestao">R$ {{ preco_sugerido|floatformat:2 }}</strong><br>
                        <small>Pre√ßo com <strong>{{ passeio.margem_lucro_desejada|floatformat:0 }}%</strong> de margem</small>
                    </div>
                    <div style="text-align: right;">
                        <strong class="lucro" style="font-size: 1.2em;">+ R$ {{ lucro_por_pessoa_ideal|floatformat:2 }}</strong><br>
                        <small>Lucro por pessoa</small>
                    </div>
                </div>
                <div class="summary-item">
                    <div>
                        <strong style="font-size: 1.1em;" class="atencao">R$ {{ preco_promocional_sugerido|floatformat:2 }}</strong><br>
                        <small>Pre√ßo com <strong>{{ passeio.margem_lucro_promocional|floatformat:0 }}%</strong> de margem (promocional)</small>
                    </div>
                    <div style="text-align: right;">
                        <strong class="lucro" style="font-size: 1.1em;">+ R$ {{ lucro_por_pessoa_promocional|floatformat:2 }}</strong><br>
                        <small>Lucro por pessoa</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if margem_sugerida is not None %}
    <div class="card">
        <h2>üí° Sugest√£o Inteligente</h2>
        <p>Com base em <strong>{{ passeios_similares_count }}</strong> passeio(s) anterior(es) para o mesmo destino, o sistema identificou que a margem de lucro m√©dia obtida foi de:</p>
        <div class="summary-item">
            <span>Margem de Lucro Sugerida</span>
            <span class="total sugestao">{{ margem_sugerida|floatformat:2 }}%</span>
        </div>
        <p style="font-size: 0.9em; margin-top: 10px;">Voc√™ pode usar este valor no campo "Margem de Lucro Desejada" na <a href="{% url 'admin:passeios_passeio_change' passeio.pk %}">p√°gina de edi√ß√£o do passeio</a> para recalcular o pre√ßo de venda.</p>
    </div>
    {% endif %}

    <div class="card">
        <h2>Situa√ß√£o Financeira Atual</h2>
        <div class="summary-item">
            <span>Total Arrecadado (Recebido)</span>
            <strong class="lucro">R$ {{ total_arrecadado|floatformat:2 }}</strong>
        </div>
        <div class="summary-item">
            <span>Saldo a Receber</span>
            <strong>R$ {{ saldo_a_receber|floatformat:2 }}</strong>
        </div>
        <hr>
        <div class="summary-item">
            <span>Resultado Atual (Arrecadado - Custos)</span>
            <strong class="{% if lucro_atual >= 0 %}lucro{% else %}prejuizo{% endif %}">R$ {{ lucro_atual|floatformat:2 }}</strong>
        </div>
    </div>

    <div class="module action-buttons">
        <p><a href="{% url 'admin:passeios_passeio_changelist' %}" class="button">Voltar para a lista de passeios</a></p>
        <p style="margin-top: 10px;">
            <button onclick="window.print()" class="button">Imprimir Relat√≥rio</button>
        </p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('costsChart').getContext('2d');
    const chartData = {{ chart_data_json|safe }};

    if (chartData.data.length > 0) {
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Distribui√ß√£o de Custos',
                    data: chartData.data,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                        '#E7E9ED', '#83D47E', '#E07E7E', '#7E8CE0'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    title: { display: true, text: 'Distribui√ß√£o de Custos por Categoria', font: { size: 14 } }
                }
            }
        });
    }
});
</script>
{% endblock %}