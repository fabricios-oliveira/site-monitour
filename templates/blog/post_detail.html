{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }} - Blog MONITOUR{% endblock %}

{% block meta %}
<meta name="description" content="{{ post.excerpt|default:post.content|truncatewords:30|striptags }}">
<meta name="keywords" content="blog, turismo, viagem, {{ post.category.name }}, MONITOUR">
<meta name="author" content="{{ post.author.get_full_name|default:post.author.username }}">
<meta property="og:title" content="{{ post.title }} - Blog MONITOUR">
<meta property="og:description" content="{{ post.excerpt|default:post.content|truncatewords:30|striptags }}">
{% if post.featured_image %}
<meta property="og:image" content="{{ request.build_absolute_uri:post.featured_image.url }}">
{% endif %}
<meta property="og:type" content="article">
<meta property="article:published_time" content="{{ post.created_at|date:'c' }}">
<meta property="article:modified_time" content="{{ post.updated_at|date:'c' }}">
<meta property="article:author" content="{{ post.author.get_full_name|default:post.author.username }}">
<meta property="article:section" content="{{ post.category.name }}">
{% endblock %}

{% block content %}
<!-- Hero Section do Post -->
<section class="relative {% if post.featured_image %}h-96{% else %}h-64{% endif %} overflow-hidden">
    {% if post.featured_image %}
        <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" 
             class="w-full h-full object-cover">
        <!-- Overlay escuro para melhor legibilidade -->
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    {% else %}
        <div class="w-full h-full bg-gradient-to-br from-primary via-purple-500 to-secondary flex items-center justify-center">
            <i class="fas fa-newspaper text-8xl text-white opacity-30"></i>
        </div>
    {% endif %}
    
    <!-- Breadcrumb -->
    <div class="absolute top-6 left-6 z-10">
        <nav class="flex items-center space-x-2 text-white text-sm">
            <a href="{% url 'core:home' %}" class="hover:text-primary transition-colors">
                <i class="fas fa-home"></i> In√≠cio
            </a>
            <i class="fas fa-chevron-right text-xs opacity-60"></i>
            <a href="{% url 'blog:post_list' %}" class="hover:text-primary transition-colors">
                Blog
            </a>
            <i class="fas fa-chevron-right text-xs opacity-60"></i>
            <a href="{% url 'blog:post_list' %}?category={{ post.category.slug }}" 
               class="hover:text-primary transition-colors">
                {{ post.category.name }}
            </a>
        </nav>
    </div>
    
    <!-- Informa√ß√µes do Post -->
    <div class="absolute bottom-8 left-8 right-8 z-10">
        <div class="bg-white bg-opacity-95 backdrop-blur-sm rounded-lg p-6 md:p-8 shadow-xl">
            <div class="flex items-center mb-4">
                <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-semibold">
                    {{ post.category.name }}
                </span>
                <div class="flex items-center ml-auto text-gray-600 text-sm">
                    <i class="fas fa-calendar mr-2"></i>
                    <span>{{ post.created_at|date:"d/m/Y" }}</span>
                    <span class="mx-3">‚Ä¢</span>
                    <i class="fas fa-clock mr-2"></i>
                    <span>{{ post.reading_time }} min de leitura</span>
                </div>
            </div>
            
            <h1 class="text-3xl md:text-4xl font-bold text-secondary mb-4 leading-tight">
                {{ post.title }}
            </h1>
            
            {% if post.excerpt %}
            <p class="text-lg text-gray-700 mb-4 leading-relaxed">
                {{ post.excerpt }}
            </p>
            {% endif %}
            
            <div class="flex items-center">
                <div class="flex items-center">
                    {% if post.author.profile.avatar %}
                        <img src="{{ post.author.profile.avatar.url }}" 
                             alt="{{ post.author.get_full_name|default:post.author.username }}"
                             class="w-10 h-10 rounded-full mr-3 object-cover">
                    {% else %}
                        <div class="w-10 h-10 bg-gray-300 rounded-full mr-3 flex items-center justify-center">
                            <i class="fas fa-user text-gray-500"></i>
                        </div>
                    {% endif %}
                    <div>
                        <div class="font-semibold text-gray-800">
                            {{ post.author.get_full_name|default:post.author.username }}
                        </div>
                        <div class="text-sm text-gray-600">Autor</div>
                    </div>
                </div>
                
                <!-- Bot√µes de Compartilhamento -->
                <div class="ml-auto flex items-center space-x-2">
                    <span class="text-sm text-gray-600 mr-2">Compartilhar:</span>
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" 
                       target="_blank"
                       class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full transition-colors">
                        <i class="fab fa-facebook-f text-sm"></i>
                    </a>
                    <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ post.title }}" 
                       target="_blank"
                       class="bg-blue-400 hover:bg-blue-500 text-white p-2 rounded-full transition-colors">
                        <i class="fab fa-twitter text-sm"></i>
                    </a>
                    <a href="https://wa.me/?text={{ post.title }} - {{ request.build_absolute_uri }}" 
                       target="_blank"
                       class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-full transition-colors">
                        <i class="fab fa-whatsapp text-sm"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Conte√∫do do Post -->
<section class="py-16">
    <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-12">
            
            <!-- Conte√∫do Principal -->
            <div class="lg:col-span-3">
                <article class="bg-white rounded-xl shadow-lg p-8 md:p-12">
                    <div class="prose prose-lg max-w-none">
                        {{ post.content|linebreaks }}
                    </div>
                    
                    <!-- Tags do Post -->
                    {% if post.tags.all %}
                    <div class="mt-12 pt-8 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Tags:</h4>
                        <div class="flex flex-wrap gap-2">
                            {% for tag in post.tags.all %}
                            <span class="bg-gray-100 hover:bg-primary hover:text-white text-gray-700 px-3 py-1 rounded-full text-sm transition-colors cursor-pointer">
                                {{ tag.name }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Informa√ß√µes do Autor -->
                    <div class="mt-12 pt-8 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Sobre o Autor</h4>
                        <div class="flex items-start space-x-4">
                            {% if post.author.profile.avatar %}
                                <img src="{{ post.author.profile.avatar.url }}" 
                                     alt="{{ post.author.get_full_name|default:post.author.username }}"
                                     class="w-16 h-16 rounded-full object-cover">
                            {% else %}
                                <div class="w-16 h-16 bg-gray-300 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-gray-500 text-xl"></i>
                                </div>
                            {% endif %}
                            <div>
                                <h5 class="font-semibold text-gray-800 text-lg">
                                    {{ post.author.get_full_name|default:post.author.username }}
                                </h5>
                                {% if post.author.profile.bio %}
                                    <p class="text-gray-600 mt-2">{{ post.author.profile.bio }}</p>
                                {% else %}
                                    <p class="text-gray-600 mt-2">Escritor e especialista em turismo na MONITOUR.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </article>
                
                <!-- Se√ß√£o de Coment√°rios -->
                <div class="mt-12 bg-white rounded-xl shadow-lg p-8">
                    <h3 class="text-2xl font-bold text-secondary mb-6 flex items-center">
                        <i class="fas fa-comments text-primary mr-3"></i>
                        Coment√°rios
                        <span class="ml-2 text-lg font-normal text-gray-500">({{ comments.count }})</span>
                    </h3>
                    
                    <!-- Formul√°rio para Novo Coment√°rio -->
                    {% if user.is_authenticated %}
                    <form method="post" action="#comments" class="mb-8" id="comment-form">
                        {% csrf_token %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" name="name" placeholder="Seu nome" required
                                   value="{{ user.get_full_name|default:user.username }}"
                                   class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <input type="email" name="email" placeholder="Seu email" required
                                   value="{{ user.email }}"
                                   class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <textarea name="content" rows="4" placeholder="Deixe seu coment√°rio..." required
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none mb-4"></textarea>
                        <button type="submit" 
                                class="bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg transition-colors flex items-center">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Publicar Coment√°rio
                        </button>
                    </form>
                    {% else %}
                    <div class="bg-gray-50 rounded-lg p-6 mb-8 text-center">
                        <p class="text-gray-600 mb-4">Fa√ßa login para deixar um coment√°rio</p>
                        <a href="{% url 'admin:login' %}?next={{ request.get_full_path }}" 
                           class="bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg transition-colors inline-flex items-center">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            Fazer Login
                        </a>
                    </div>
                    {% endif %}
                    
                    <!-- Lista de Coment√°rios -->
                    {% if comments %}
                    <div class="space-y-6" id="comments">
                        {% for comment in comments %}
                        <div class="border-b border-gray-200 pb-6 last:border-b-0">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center mr-3">
                                        {{ comment.name|first|upper }}
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-gray-800">{{ comment.name }}</h5>
                                        <p class="text-sm text-gray-600">{{ comment.created_at|date:"d/m/Y √†s H:i" }}</p>
                                    </div>
                                </div>
                                {% if comment.is_approved %}
                                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                                        Aprovado
                                    </span>
                                {% else %}
                                    <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">
                                        Aguardando aprova√ß√£o
                                    </span>
                                {% endif %}
                            </div>
                            <div class="ml-13">
                                <p class="text-gray-700">{{ comment.content|linebreaks }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-comments text-gray-300 text-4xl mb-4"></i>
                        <p class="text-gray-600">Ainda n√£o h√° coment√°rios. Seja o primeiro a comentar!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <!-- Newsletter -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h4 class="text-lg font-bold text-secondary mb-4 text-center">
                        üìß Newsletter MONITOUR
                    </h4>
                    <p class="text-gray-600 text-sm mb-4 text-center">
                        Receba dicas de viagem e ofertas exclusivas!
                    </p>
                    <form method="post" action="{% url 'core:newsletter' %}" class="space-y-3">
                        {% csrf_token %}
                        <input type="email" name="email" placeholder="Seu email" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-transparent">
                        <button type="submit" 
                                class="w-full bg-primary hover:bg-primary-dark text-white py-2 rounded-lg transition-colors text-sm font-semibold">
                            Inscrever-se
                        </button>
                    </form>
                </div>
                
                <!-- Posts Relacionados -->
                {% if related_posts %}
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h4 class="text-lg font-bold text-secondary mb-4 flex items-center">
                        <i class="fas fa-newspaper text-primary mr-2"></i>
                        Posts Relacionados
                    </h4>
                    <div class="space-y-4">
                        {% for related_post in related_posts|slice:":3" %}
                        <article class="group">
                            <a href="{% url 'blog:post_detail' related_post.slug %}" 
                               class="flex items-start space-x-3 hover:bg-gray-50 p-2 rounded-lg transition-colors">
                                {% if related_post.featured_image %}
                                    <img src="{{ related_post.featured_image.url }}" 
                                         alt="{{ related_post.title }}"
                                         class="w-16 h-12 object-cover rounded flex-shrink-0">
                                {% else %}
                                    <div class="w-16 h-12 bg-gray-200 rounded flex-shrink-0 flex items-center justify-center">
                                        <i class="fas fa-image text-gray-400 text-xs"></i>
                                    </div>
                                {% endif %}
                                <div class="flex-1 min-w-0">
                                    <h5 class="text-sm font-semibold text-gray-800 group-hover:text-primary transition-colors line-clamp-2 mb-1">
                                        {{ related_post.title }}
                                    </h5>
                                    <p class="text-xs text-gray-500">
                                        {{ related_post.created_at|date:"d/m/Y" }}
                                    </p>
                                </div>
                            </a>
                        </article>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Categorias -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h4 class="text-lg font-bold text-secondary mb-4 flex items-center">
                        <i class="fas fa-folder text-primary mr-2"></i>
                        Categorias
                    </h4>
                    <div class="space-y-2">
                        {% for category in categories %}
                        <a href="{% url 'blog:post_list' %}?category={{ category.slug }}" 
                           class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg transition-colors group">
                            <span class="text-sm text-gray-700 group-hover:text-primary">{{ category.name }}</span>
                            <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full">
                                {{ category.posts.count }}
                            </span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Call to Action -->
                <div class="bg-gradient-to-br from-primary to-secondary rounded-xl shadow-lg p-6 text-white text-center">
                    <i class="fas fa-suitcase-rolling text-3xl mb-4 opacity-80"></i>
                    <h4 class="text-lg font-bold mb-2">Pronto para Viajar?</h4>
                    <p class="text-sm opacity-90 mb-4">
                        Descubra nossos pacotes incr√≠veis e comece a planejar sua pr√≥xima aventura!
                    </p>
                    <a href="{% url 'packages:package_list' %}" 
                       class="bg-white text-primary hover:bg-gray-100 px-6 py-2 rounded-lg transition-colors font-semibold inline-flex items-center">
                        <i class="fas fa-search mr-2"></i>
                        Ver Pacotes
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Scripts -->
<script>
// Smooth scroll para coment√°rios
document.addEventListener('DOMContentLoaded', function() {
    // Se h√° um hash #comments na URL, fazer scroll suave
    if (window.location.hash === '#comments') {
        setTimeout(function() {
            document.getElementById('comments').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }, 100);
    }
});

// Valida√ß√£o do formul√°rio de coment√°rio
document.getElementById('comment-form')?.addEventListener('submit', function(e) {
    const content = this.querySelector('textarea[name="content"]').value.trim();
    
    if (content.length < 10) {
        e.preventDefault();
        alert('Por favor, escreva um coment√°rio com pelo menos 10 caracteres.');
        return false;
    }
    
    // Mostrar feedback visual
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';
    submitBtn.disabled = true;
    
    // Restaurar ap√≥s 3 segundos (em caso de erro)
    setTimeout(function() {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 3000);
});

// Contador de caracteres para o coment√°rio
const commentTextarea = document.querySelector('textarea[name="content"]');
if (commentTextarea) {
    const maxChars = 1000;
    const counter = document.createElement('div');
    counter.className = 'text-xs text-gray-500 text-right mt-1';
    counter.textContent = `0/${maxChars} caracteres`;
    
    commentTextarea.parentNode.insertBefore(counter, commentTextarea.nextSibling);
    
    commentTextarea.addEventListener('input', function() {
        const currentLength = this.value.length;
        counter.textContent = `${currentLength}/${maxChars} caracteres`;
        
        if (currentLength > maxChars * 0.9) {
            counter.className = 'text-xs text-red-500 text-right mt-1';
        } else {
            counter.className = 'text-xs text-gray-500 text-right mt-1';
        }
    });
}
</script>
{% endblock %}